# Build stage - Instalar dependencias
FROM composer:2.6 as builder

WORKDIR /app

# Copiar composer files
COPY composer.json composer.lock ./

# Instalar sin scripts (evita error de artisan)
RUN composer install \
    --prefer-dist \
    --no-dev \
    --optimize-autoloader \
    --no-interaction \
    --no-progress \
    --no-scripts

# Runtime stage
FROM php:8.2-fpm-alpine

# Instalar extensiones necesarias
RUN apk add --no-cache \
    postgresql-dev \
    libzip-dev \
    oniguruma-dev \
    freetype-dev \
    libjpeg-turbo-dev \
    libpng-dev \
    zip \
    curl \
    nginx \
    supervisor \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) \
    pdo_pgsql \
    mbstring \
    zip \
    bcmath \
    gd \
    && rm -rf /var/cache/apk/*

# Configurar PHP
RUN echo 'memory_limit = 256M' > /usr/local/etc/php/conf.d/memory.ini

WORKDIR /app

# Copiar dependencias desde builder
COPY --from=builder /app/vendor ./vendor

# Copiar .env.example PRIMERO para que est√© disponible
COPY .env.example .env.example

# Copiar aplicaci√≥n
COPY . .

# Limpiar cach√©s de bootstrap (contienen referencias a proveedores que pueden no estar disponibles)
RUN rm -rf bootstrap/cache/* \
    && mkdir -p storage/logs bootstrap/cache \
    && chmod -R 775 storage bootstrap/cache

# Copiar configuraci√≥n de Nginx
COPY nginx.conf.docker /etc/nginx/http.d/default.conf

# Copiar supervisord config
RUN cat > /etc/supervisord.conf << 'EOF'
[supervisord]
nodaemon=true
logfile=/var/log/supervisord.log

[program:php-fpm]
command=php-fpm
autostart=true
autorestart=true
stderr_logfile=/var/log/php-fpm.err.log
stdout_logfile=/var/log/php-fpm.out.log

[program:nginx]
command=nginx -g "daemon off;"
autostart=true
autorestart=true
stderr_logfile=/var/log/nginx.err.log
stdout_logfile=/var/log/nginx.out.log
EOF


# Script de inicializaci√≥n
RUN cat > /entrypoint.sh << 'EOF'
#!/bin/sh
set -e

echo "üöÄ Iniciando aplicaci√≥n en Docker..."

if [ ! -f .env ]; then
    echo "Creating .env file..."
    cp .env.example .env || true
fi

# Asegurar que APP_KEY est√° configurado
if ! grep -q "^APP_KEY=" .env; then
    echo "‚ö†Ô∏è APP_KEY no encontrado, usando placeholder..."
    echo "APP_KEY=base64:PLACEHOLDER_KEY_WILL_BE_GENERATED" >> .env
fi

# Limpiar cach√©s antiguos antes de regenerarlos
rm -rf bootstrap/cache/*.php storage/framework/cache/data/* 2>/dev/null || true

# Generar APP_KEY solo si no existe o es placeholder
if grep -q "PLACEHOLDER_KEY_WILL_BE_GENERATED" .env; then
    echo "üîë Generando APP_KEY..."
    php artisan key:generate --force 2>/dev/null || echo "‚ö†Ô∏è No se pudo generar APP_KEY"
fi

# Caching r√°pido (no ejecuta migraciones)
echo "‚öôÔ∏è Cacheando configuraci√≥n..."
php artisan config:cache 2>/dev/null || echo "‚ö†Ô∏è Config cache fall√≥"
php artisan route:cache 2>/dev/null || echo "‚ö†Ô∏è Route cache fall√≥"
php artisan view:cache 2>/dev/null || echo "‚ö†Ô∏è View cache fall√≥"

echo "‚úÖ Inicializaci√≥n r√°pida completada"
echo "üåê Iniciando servidor..."

# Ejecutar migraciones y seeder en background (no bloquea el servidor)
(
    sleep 5  # Esperar a que el servidor est√© listo
    echo ""
    echo "üì¶ Ejecutando migraciones en background..."
    php artisan migrate --force --no-interaction 2>/dev/null || echo "‚ö†Ô∏è Las migraciones fallaron"
    
    echo "üë• Ejecutando seeder en background..."
    php artisan db:seed --class=UsuarioTestSeeder --force --no-interaction 2>/dev/null || echo "‚ö†Ô∏è El seeder fall√≥"
    
    echo "‚úÖ Migraciones y seeder completadas"
) &

exec supervisord -c /etc/supervisord.conf

exec supervisord -c /etc/supervisord.conf
EOF

RUN chmod +x /entrypoint.sh

EXPOSE 8080

ENTRYPOINT ["/entrypoint.sh"]

