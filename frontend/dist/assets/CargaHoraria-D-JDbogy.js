import{a as g,j as e}from"./index-ChjEM8xn.js";import{b as s}from"./react-vendor-AZ7bSPkM.js";import"./axios-vendor-R-lXtGyY.js";const M=({cargaHoraria:d,onSubmit:E,onClose:x})=>{const[c,w]=s.useState({codigo_doc:"",codigo_grupo:"",nro_aula:"",id_horario:"",periodo_academico:"",estado:"ACTIVO"}),[j,$]=s.useState([]),[v,L]=s.useState([]),[_,C]=s.useState([]),[y,h]=s.useState([]),[R,f]=s.useState([]),[k,I]=s.useState(!0),[r,m]=s.useState({});s.useEffect(()=>{S(),d&&w({codigo_doc:d.codigo_doc,codigo_grupo:d.codigo_grupo,nro_aula:d.nro_aula,id_horario:d.id_horario,periodo_academico:d.periodo_academico,estado:d.estado||"ACTIVO"})},[d]);const S=async()=>{try{I(!0);const[o,t,l,i]=await Promise.all([g.get("/docentes"),g.get("/grupos"),g.get("/aulas"),g.get("/horarios")]);console.log("DEBUG - Respuesta API /docentes:",o);const p=Array.isArray(o.data.data)?o.data.data:Array.isArray(o.data)?o.data:[];console.log("DEBUG - Docentes procesados:",p),$(p),console.log("Respuesta API /grupos:",t);const N=t.data.data||t.data||[];console.log("Grupos procesados:",N),C(N),console.log("Respuesta API /aulas:",l);const b=l.data.data||l.data||[];console.log("Aulas procesadas:",b),h(b),console.log("Respuesta API /horarios:",i);const D=i.data.data||i.data||[];console.log("Horarios procesados:",D),f(D)}catch(o){console.error("Error loading form data:",o)}finally{I(!1)}},u=o=>{const{name:t,value:l}=o.target;w(i=>({...i,[t]:l})),r[t]&&m(i=>({...i,[t]:""}))},A=async o=>{if(o.preventDefault(),!c.codigo_doc||!c.codigo_grupo||!c.nro_aula||!c.id_horario||!c.periodo_academico){m({general:"Todos los campos son requeridos"});return}try{E(c)}catch(t){m({general:t.message})}},F=o=>{if(!o)return"Desconocido";let t=o.usuario?.persona?.nombre_completo;t||(t=o.nombre_docente||`Docente ${o.codigo_doc}`);let l=[];return o.asignaciones&&Array.isArray(o.asignaciones)&&(l=o.asignaciones.map(i=>i.grupo?.materia?.nombre_mat).filter(Boolean).filter((i,p,N)=>N.indexOf(i)===p)),l.length>0?`${t} (${l.join(", ")})`:t},G=o=>{if(!o)return"Desconocido";const t=o.codigo_grupo||"Desconocido",l=o.materia?.nombre_mat||o.nombre_mat||"Sin materia",i=o.capacidad_de_grupo||0;return`${t} (${l} - Capacidad: ${i})`};return k?e.jsx("div",{className:"modal-overlay",children:e.jsx("div",{className:"modal-content",children:e.jsx("p",{children:"Cargando..."})})}):e.jsx("div",{className:"modal-overlay",onClick:x,children:e.jsxs("div",{className:"modal-content",onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:d?"Editar Asignación":"Nueva Asignación de Carga Horaria"}),e.jsx("button",{className:"close-btn",onClick:x,children:"×"})]}),e.jsxs("form",{onSubmit:A,className:"form-group",children:[r.general&&e.jsx("div",{className:"alert alert-danger",children:r.general}),e.jsxs("div",{style:{marginBottom:8,color:"#888",fontSize:13},children:["Docentes cargados: ",j.length]}),j.length===0&&e.jsx("div",{className:"alert alert-warning",style:{marginBottom:12},children:"No hay docentes disponibles para seleccionar. Verifique permisos o datos cargados."}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-col",children:[e.jsx("label",{children:"Docente *"}),e.jsxs("select",{name:"codigo_doc",value:c.codigo_doc,onChange:u,className:`form-control ${r.codigo_doc?"error":""}`,children:[e.jsx("option",{value:"",children:"Seleccionar docente"}),j.map(o=>e.jsx("option",{value:o.codigo_doc,children:F(o)},o.codigo_doc))]}),r.codigo_doc&&e.jsx("span",{className:"error-message",children:r.codigo_doc})]}),e.jsxs("div",{className:"form-col",children:[e.jsx("label",{children:"Período Académico *"}),e.jsx("input",{type:"text",name:"periodo_academico",value:c.periodo_academico,onChange:u,placeholder:"Ej: 2024-1",className:`form-control ${r.periodo_academico?"error":""}`}),r.periodo_academico&&e.jsx("span",{className:"error-message",children:r.periodo_academico})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-col",children:[e.jsx("label",{children:"Grupo *"}),e.jsxs("select",{name:"codigo_grupo",value:c.codigo_grupo,onChange:u,className:`form-control ${r.codigo_grupo?"error":""}`,children:[e.jsx("option",{value:"",children:"Seleccionar grupo"}),_.map(o=>e.jsx("option",{value:o.codigo_grupo,children:G(o)},o.codigo_grupo))]}),r.codigo_grupo&&e.jsx("span",{className:"error-message",children:r.codigo_grupo})]}),e.jsxs("div",{className:"form-col",children:[e.jsx("label",{children:"Aula *"}),e.jsxs("select",{name:"nro_aula",value:c.nro_aula,onChange:u,className:`form-control ${r.nro_aula?"error":""}`,children:[e.jsx("option",{value:"",children:"Seleccionar aula"}),y.map(o=>e.jsxs("option",{value:o.nro_aula,children:[o.nro_aula," (Capacidad: ",o.capacidad_aula,")"]},o.nro_aula))]}),r.nro_aula&&e.jsx("span",{className:"error-message",children:r.nro_aula})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-col",children:[e.jsx("label",{children:"Horario *"}),e.jsxs("select",{name:"id_horario",value:c.id_horario,onChange:u,className:`form-control ${r.id_horario?"error":""}`,children:[e.jsx("option",{value:"",children:"Seleccionar horario"}),R.map(o=>e.jsxs("option",{value:o.id_horario,children:[o.dias_semana||o.dia," - ",o.hora_inicio," a ",o.hora_fin]},o.id_horario))]}),r.id_horario&&e.jsx("span",{className:"error-message",children:r.id_horario})]}),e.jsxs("div",{className:"form-col",children:[e.jsx("label",{children:"Estado *"}),e.jsxs("select",{name:"estado",value:c.estado,onChange:u,className:"form-control",children:[e.jsx("option",{value:"ACTIVO",children:"Activo"}),e.jsx("option",{value:"INACTIVO",children:"Inactivo"})]})]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsxs("button",{type:"submit",className:"btn btn-success",children:[e.jsx("i",{className:"fas fa-save"})," Guardar"]}),e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:x,children:[e.jsx("i",{className:"fas fa-times"})," Cancelar"]})]})]})]})})},U=()=>{const[d,E]=s.useState([]),[x,c]=s.useState([]),[w,j]=s.useState(!0),[$,v]=s.useState(null),[L,_]=s.useState(!1),[C,y]=s.useState(null),[h,R]=s.useState(""),[f,k]=s.useState(""),[I,r]=s.useState([]),[m,S]=s.useState(1),[u]=s.useState(10);s.useEffect(()=>{A(),F()},[]),s.useEffect(()=>{G()},[d,h,f]);const A=async()=>{try{j(!0);const a=await g.get("/asignaciones"),n=a.data.data||a.data||[];E(n),v(null)}catch(a){v("Error al cargar las asignaciones: "+(a.response?.data?.message||a.message)),console.error(a),E([])}finally{j(!1)}},F=async()=>{try{const a=await g.get("/docentes");console.log("Respuesta API /docentes:",a);const n=a.data.data||a.data||[];console.log("Docentes procesados:",n),r(n)}catch(a){console.error("Error al cargar docentes:",a),r([])}},G=()=>{let a=d;h&&(a=a.filter(n=>{const P=n.docente?.usuario?.persona?.nombre_completo||`Docente ${n.codigo_doc}`||"",T=n.grupo?.materia?.nombre_mat||"",H=n.grupo?.codigo_grupo||"";return P.toLowerCase().includes(h.toLowerCase())||T.toLowerCase().includes(h.toLowerCase())||H.toLowerCase().includes(h.toLowerCase())})),f&&(a=a.filter(n=>n.codigo_doc==f)),c(a),S(1)},o=async a=>{try{C?await g.put(`/asignaciones/${C.id_asignacion}`,a):await g.post("/asignaciones",a),_(!1),y(null),A()}catch(n){v("Error al guardar asignación: "+(n.response?.data?.message||n.message)),console.error(n)}},t=a=>{y(a),_(!0)},l=async a=>{if(window.confirm("¿Está seguro de que desea eliminar esta asignación?"))try{await g.delete(`/asignaciones/${a}`),A()}catch(n){v("Error al eliminar asignación: "+n.message),console.error(n)}},i=()=>{_(!1),y(null)},p=a=>a?a.nombre_docente?a.nombre_docente:a.usuario?.persona?.nombre_completo?a.usuario.persona.nombre_completo:`Docente ${a.codigo_doc}`:"",N=a=>{if(!a)return"N/A";let n=a.hora_inicio?String(a.hora_inicio).substring(0,5):"",P=a.hora_fin?String(a.hora_fin).substring(0,5):"";return n&&P?`${n} - ${P}`:"N/A"},b=Math.ceil(x.length/u),D=(m-1)*u,B=x.slice(D,D+u);return w?e.jsx("div",{className:"loading",children:"Cargando cargas horarias..."}):e.jsxs("div",{className:"carga-horaria-container",children:[e.jsx("h2",{children:"CU11 - Asignación de Carga Horaria"}),$&&e.jsx("div",{className:"alert alert-danger",children:$}),e.jsxs("div",{className:"filters",children:[e.jsx("input",{type:"text",placeholder:"Buscar por docente, materia o grupo...",className:"search-input",value:h,onChange:a=>R(a.target.value)}),e.jsxs("select",{className:"filter-select",value:f,onChange:a=>k(a.target.value),children:[e.jsx("option",{value:"",children:"Todos los docentes"}),I.map(a=>e.jsx("option",{value:a.codigo_doc,children:p(a)},a.codigo_doc))]}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>_(!0),children:[e.jsx("i",{className:"fas fa-plus"})," Nueva Asignación"]})]}),e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-striped",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Docente"}),e.jsx("th",{children:"Materia"}),e.jsx("th",{children:"Grupo"}),e.jsx("th",{children:"Aula"}),e.jsx("th",{children:"Horario"}),e.jsx("th",{children:"Periodo Académico"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:B.length>0?B.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.id_asignacion}),e.jsx("td",{children:p(a.docente)}),e.jsx("td",{children:a.grupo?.materia?.nombre_mat||"N/A"}),e.jsx("td",{children:a.grupo?.codigo_grupo||"N/A"}),e.jsx("td",{children:a.nro_aula}),e.jsx("td",{children:N(a.horario)}),e.jsx("td",{children:a.periodo_academico||"No definido"}),e.jsxs("td",{children:[e.jsxs("button",{className:"btn btn-sm btn-warning",onClick:()=>t(a),children:[e.jsx("i",{className:"fas fa-edit"})," Editar"]}),e.jsxs("button",{className:"btn btn-sm btn-danger",onClick:()=>l(a.id_asignacion),children:[e.jsx("i",{className:"fas fa-trash"})," Eliminar"]})]})]},a.id_asignacion)):e.jsx("tr",{children:e.jsx("td",{colSpan:"8",className:"text-center",children:"No hay asignaciones de carga horaria"})})})]})}),b>1&&e.jsxs("div",{className:"pagination",children:[e.jsx("button",{disabled:m===1,onClick:()=>S(m-1),children:"Anterior"}),e.jsxs("span",{children:["Página ",m," de ",b]}),e.jsx("button",{disabled:m===b,onClick:()=>S(m+1),children:"Siguiente"})]}),L&&e.jsx(M,{cargaHoraria:C,onSubmit:o,onClose:i})]})};export{U as default};
